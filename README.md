# 数据中心的构建与管理 | 提纲目录（详细）
● 数据中心概述
● 数据中心的设计与构建
● 数据中心的管理和维护
● 数据中心的需求和挑战
● 小结


# 数据中心的构建与管理 | 数据中心概述（云计算和数据中心的关系）
- 云：指互联网
- 云计算：算力来自云（互联网）的计算
- 云（互联网）的算力来自哪儿？数据中心


# 数据中心的构建与管理 | 数据中心概述（数据中心定义）
数据中心：是信息系统的中心，通过网络向企业或公众提供信息服务  
- 信息——血液  
- 网络——血管  
- 数据中心——心脏


# 数据中心的构建与管理 | 数据中心概述（数据中心的演进）
● 大型机的机房  
● 服务器的机房  
● 数据中心  

[图片：20世纪60年代的大型机]  
[图片：服务器机房]  
[图片：数据中心网络拓扑图，包含Internet链路、负载均衡、抗DDOS攻击、Web防火墙、应用级防火墙、核心交换机、汇聚交换机、存储设备、数据库服务器、备份存储阵列等模块，标注“本项目新建内容”“利旧”等信息，涉及省电子政务、交通运输部、市州交通运输局（委）及厅直单位等接入对象]


# 数据中心的构建与管理 | 数据中心概述（数据中心和服务器机房的区别）
● 数据中心规模更大  
● 数据中心构成更复杂  
  - 支撑系统（环控系统、电力系统、监控系统等）  
  - 计算设备（服务器、存储、网络系统、安全系统等）  
  - 信息服务（支撑软件、业务系统、数据库等）  
● 数据中心技术更先进（虚拟化等）


# 数据中心的构建与管理 | 数据中心概述（计算模式发展阶段）
| 发展阶段               | 类型         | 代表公司或产品                | 对应基础设施       | 资源   |
|------------------------|--------------|-----------------------------|--------------------|--------|
| 大型机/终端（键盘、显示器） | 中心化       | IBM，Unix                   | 大型机机房         | 算力   |
| 个人电脑（PC）         | 去中心化     | IBM，微软，dos, windows     | ——                 | 算力   |
| 服务器/客户端（C/S）   | 中心化       | 雅虎，搜狐，新浪             | 服务器机房         | 内容   |
| 对等网（Peer to Peer, P2P） | 去中心化   | eMule，PP点点通              | ——                 | 内容   |
| 云计算/移动互联网       | 中心化       | 小米，阿里                   | 数据中心           | 服务   |
| Web 3.0（区块链）       | 去中心化     | 比特币，以太坊               | ——                 | 服务   |
| 人工智能               | 中心化       | ChatGPT，DeepSeek            | 智算平台           | 智能   |
| …                      | 去中心化     | …                           | ——                 | 智能   |

**注**：中心化到去中心化：本质是从稀有到普及，从垄断到开放；从更大范围看，数据中心是计算模式演进的产物


# 数据中心的构建与管理 | 提纲目录（重复）
● 数据中心概述
● 数据中心的设计与构建
● 数据中心的管理和维护
● 数据中心的需求和挑战
● 小结


# 数据中心的构建与管理 | 数据中心的设计和构建（1. 总体设计）
● 数据中心的设计是一个系统、复杂、迭代的过程  
● 在特定预算的情况下，让数据中心能够满足现有及将来不断增长的业务需求  
● 我国的《数据中心设计规范》（GB 50174-2017）为数据中心的设计，尤其是建筑、机电、通风等基础设施的规划提供了基本的依据  
● 遵循简单、灵活、可扩展、模块化的原则


# 数据中心的构建与管理 | 数据中心的设计和构建（数据中心等级分类标准）
● 基础级：该级别的数据中心没有冗余设备（包括计算机和存储），所有设备由一套线路系统（包括电力和网络）相连通  
● 具备冗余设备级：该级别的数据中心具有冗余设备，但是所有设备仍由一套线路系统相连通  
● 可并行维护级：该级别数据中心具有冗余设备，所有计算机设备都具备双电源并按照数据中心的建筑结构合理安装。  
● 容错级：该级别数据中心具有多重的、独立的、物理上相互分隔的冗余设备，所有计算机设备都具备双电源并按照数据中心的建筑结构合理安装。


# 数据中心的构建与管理 | 数据中心的设计和构建（2. 建筑的设计与构建）
数据中心的建筑从选址到安全、高度和承重方面都有严格的标准  
无论是利用现有的建筑还是构建新的建筑都需要考虑数据中心构建标准  


## 2.1 数据中心的选址
数据中心的选址要综合考虑多种因素，其中通信、电力和地理位置是选址的三个主要因素  
如：  
- 电力供应稳定可靠，通信便捷  
- 自然环境清洁，远离粉尘、油烟、有害气体等场所  
- 远离强振源和强噪声源  
- 避开强电磁场干扰  
- 可能发生洪水的地区不应设置机房  
- 地下室不应做机房  
- 内蒙和贵州的大数据中心选址，咱们学校北区机房的选址  


## 2.2 数据中心建筑的特殊设计要求
数据中心的建筑与普通建筑不同，有一些特殊的设计要求，主要包括建筑的规模、布局、高度、地板的承重和室内布局等  
如：  
- 地板承重不小于1000千克/平方米  
- 放置UPS电源的地板承重不低于1600千克/平方米  
- 机房高度不低于3.5米  
- 走廊、货梯、门的尺寸不小于1.5米×2.1米  
- 机房区域需无窗设计  


## 2.3 数据中心的施工
为保证工程质量，需要有专门的监管部门控制施工进度，并根据设定的标准进行阶段性验收，项目完成后还需要进行全面验收才能交付  


# 数据中心的构建与管理 | 数据中心的设计和构建（3. 基础设施的设计与构建）
为了确保设备的正常运行，网络、电力和环境控制设施等基础设施是必不可少的  
● 电力是数据中心运行的动力  
● 网络保证了服务器及存储的互联和访问  
● 环境控制设备为设备运行提供了合适的温度、湿度等环境条件  


## 3.1 电力系统设计
● 电力系统的设计是数据中心基础设施设计中最为关键的部分，关系到数据中心能否持续、稳定的运行  
● 电力系统的设计需要考虑数据中心的电力负荷限制、冗余配备和电力设施的布局  
  如：高性能计算机柜20KW，服务器机柜8KW，存储机柜5KW，网络机柜1KW  
● 数据中心内的电力负载主要有照明用电、消防应急用电、计算机设备用电和制冷设备用电  
● 由于业务的重要性，以上各项电力负载均需冗余来保证其可用性  

[图片：UPS配电柜]  
[图片：UPS电池组（标注“有电危险”提示）]  


## 3.2 网络基础设施设计
● 网络基础设施的设计主要包括网络供应商的选择和内部网络拓扑的设计  
● 业务系统的可用性和服务质量一定程度上取决于网络供应商的服务质量  
● 数据中心网络通常有三层结构和大二层结构两种类型  


### 3.2.1 网络连接逻辑
● 网络供应商的网络接入连接到数据中心的核心交换机  
● 二级交换机向上连接到核心交换机，向下同数据中心的机柜互连  
● 机柜内部的服务器则通过机柜内置的网络交换机模块同二级交换机连接  


### 3.2.2 数据中心网络的三层结构
[图片：数据中心网络的三层结构，标注“Core（核心层）”“汇聚层”“接入层”“ACs”“Agatonn”“L3”“类楼”等信息]  


### 3.2.3 数据中心网络的大二层结构
[图片：数据中心网络的大二层结构，包含“核心层”“汇聚层”“接入层”“VSItch（虚拟交换机）”“服务器”等模块，标注“大二层均处于同一个广播域内，便于虚机的迁移”“东西向流量带宽更大，性能更高”“发生广播风暴的可能性更大”]  


### 3.2.4 数据中心网络的特点（与园区网、企业办公网对比）
● 数据中心内部网络的流量主要是机器产生的，而园区网主要是人产生的，突发性强，缺乏规律性  
● 数据中心网络链路密集、拓扑规整性强  
● 数据中心网络端到端带宽高、延迟低  
● 数据中心网络更侧重东西向网络  


## 3.3 环境控制设施设计
● 环境控制设施保证了数据中心的设备有一个适宜的运行环境  
● 包括温度、湿度、洁净度以及防静电、防雷设施等  
● 设计环境控制设施需要考虑IT设施的规模、服务器的类型和数量等  
  温度控制作为环境控制中最为重要的问题已经被广泛研究，现在数据中心常采用的制冷方式有：风冷、水冷和机架内利用空气——水热交换制冷等。  

[图片：数据中心风冷示意图，标注“空调机机房”“数据中心计算机房”“吊顶内的风装置”“热通道”“冷通道”“机架或机柜”“活动地板”“信息线缆”“供电电缆”，说明“热通道：由设备排出热风”“冷通道：由冷风送入机柜”]  
[图片：机房专用空调室内机]  
[图片：机房专用空调外机（标注“McQuay Air Conditioning”）]  
[图片：机房专用水冷机组]  
[图片：等电位线]  
[图片：防雷开关]  


# 数据中心的构建与管理 | 数据中心的设计和构建（4. 数据中心的设备）
## 4.1 网络设备
三层交换机、二层交换机、DNS等  

[图片：OSI体系结构与TCP/IP体系结构对比表，OSI体系结构分7层（应用层、表示层、会话层、运输层、网络层、数据链路层、物理层），TCP/IP体系结构分4层（应用层、运输层、网际层IP、网络接口层），标注“各种应用层协议如TELNET, FTP, SMTP等”“TCP或UDP”]  
[图片：二层交换机（标注“RCN85216G”）]  
[图片：三层交换机（标注“MAiPu”）]  
[图片：DNS服务器（标注“XMDNS-6800Z xiMO 西默科技”“DNS1 202.41.30.100”）]  


## 4.2 安全设备
防火墙、行为管理、入侵检测、堡垒机、WAF、日志审计、数据库审计等  

[图片：防火墙（标注“Firewall”“WAN”“LAN”）]  
[图片：上网行为管理系统（标注“Internet”“飞塔防火墙”“深信服上网行为管理”“核心交换机”“工作电脑”“服务器”）]  
[图片：入侵检测系统（IDS）示例，标注“攻击者”“Web服务器”“告警！”“Cisco安全管理器”“云栖社区 yq.aliyun.com 图1-4 IDS示例”，IDS分为（1）HIDS、（2）NIDS]  
[图片：堡垒机（标注“堡垒主机”“Internet”“设备中心”“IT运维人员工作区”“IT运维人员”）]  
[图片：WAF（标注“CLIENT”“ORIGIN”“WAF”，示例URL：http://www.test.com/example.jsp?id=18，对应SQL语句“Select * from users where id=18”；恶意URL：http://www.test.com/example.jsp?id=18 or ‘1’=‘1’，对应SQL语句“Select * from users where id=18 or ‘1’=‘1’”，标注“SQL注入”）]  
[图片：日志审计系统（标注“GLA天枢安全”“日志审计系统”“数据库服务器”“应用服务器”“UNIX”）]  
[图片：数据库审计（标注“交换机”“终端”“数据库系统”“业务主机”“复制”“审计系统”）]  


## 4.3 服务器
### 4.3.1 服务器概述
● 服务器是数据中心计算和数据存储的核心设备  
● 选择服务器需要综合考虑多方面因素，比如数据中心支持的服务器数量及数据中心将来要达到的规模和服务器的性能等  
● 由于服务器是主要的耗电设备，所以节能也是一个重要的考虑因素  
● 数据中心的服务器按照类型可以分为塔式服务器、机架式服务器和刀片服务器三类  


### 4.3.2 塔式服务器
与PC的主机类似，成本较低，能灵活定制，应用广泛，不足处在于扩展性有限，很难满足规模较大的并行处理应用的要求，且占地空间大，不便于挪动和管理。  

[图片：塔式服务器（标注“DLL”）]  


### 4.3.3 机架式服务器
外观按统一标准设计、配合机柜使用的服务器，可以方便地与其他网络设备连接，简化了机房的布线和管理。机架式服务器的优点是占用空间较小，单位空间可以放置更多的服务器，且管理方便。不足处是对制冷要求较高。  

**注**：1U=44.45毫米=4.445 厘米  

[图片：机架式服务器（标注“DELL”）]  


### 4.3.4 刀片服务器
是在标准高度的机箱上插装多个卡式的服务器单元，由于这些服务器单元的外观很薄，故得名刀片服务器。每一块“刀片”都是一个独立的服务器，包括系统主板、硬盘、内存等设备，可以通过板载硬盘启动操作系统，由所在的机箱提供高速的网络环境，同时共享机箱中的其他资源，协同完成计算任务。  

[图片：刀片服务器]  


## 4.4 数据中心的软件
### 4.4.1 操作系统
数据中心的软件主要包括操作系统、中间件、业务系统和辅助软件等。目前，数据中心服务器操作系统主要有三大类：  
1. UNIX系统  
2. Windows系统  
3. Linux系统  


### 4.4.2 Web服务架构
● 数据中心大多以Web的形式向外提供服务，RESTful接口  
● Web服务一般采用三层架构，从前端到后端依次为表现层、业务逻辑层和数据访问层。  
● 三层架构目前均有相关中间件的支持，如表现层的Web服务器，业务逻辑层的应用服务器，数据访问层的数据库服务器  


### 4.4.3 存储服务器
● 存储服务器：用于数据的存储和访问，包括阵列控制器和磁盘阵列  
● 阵列控制器也称机头，负责数据管理，缓存分配，快照生成等  
● 磁盘阵列：简称盘阵，若干独立的硬盘组成的磁盘组  
● 存储一般通过光纤交换机和服务器连接  

[图片：存储服务器相关示意图（包含多个“0”符号组成的阵列）]  


# 数据中心的构建与管理 | 提纲目录（重复）
● 数据中心概述
● 数据中心的设计与构建
● 数据中心的管理和维护
● 数据中心的需求和挑战
● 小结


# 数据中心的构建与管理 | 数据中心的管理和维护（概述）
数据中心的管理和维护包含很多工作，涉及多种角色，包括硬件管理、软件管理、数据管理、资源管理、安全管理等，每个角色都不可或缺。  

[图片：管理模块示意图，包含“安全管理”“硬件管理”“软件管理”“数据管理”“资源管理”]  


# 数据中心的构建与管理 | 数据中心的管理和维护（1. 硬件的管理和维护）
● 硬件的管理和维护包括对硬件的升级、定期维护和维修等  
● 升级：业务量增加，服务器升级，增加服务器数量，扩展服务器容量  
● 维护：要定期对硬件进行检查和维护，保证硬件的稳定运行，定期巡检  
● 维修：当服务器发生硬件故障时，需要及时检测和定位故障，更换发生故障的部件  

[图片：带外管理（Out-of-Band Management）界面，标注“H3C”“系统管理”“HDM设置”“远程服务”“远程运维”“用户&安全”“联合管理”，显示设备信息（如主机名、IPv4地址：专用网口10.10.150.11、产品序列号210235A2CQ5225C000ZS、MAC地址、UUID、HDM固件版本2.99、BIOS固件版本2.00.58）、设备健康状态（处理器、内存、风扇、电源、存储、PCle设备、温感等均正常）、HDM时间2025-09-04 10:22:44，包含“远程控制台”“H5 KVM”“固件更新”“一键收集”等功能按钮]  


# 数据中心的构建与管理 | 数据中心的管理和维护（2. 软件的管理和维护）
● 数据中心的常见软件包括操作系统、中间件、业务软件和相关的一些辅助软件，其管理和维护工作包括软件的安装、配置、升级等  
● 安装：安装文件安装，克隆安装，在线安装（apt, yum）  
● 配置：操作系统、中间件、数据库软件、业务软件的配置，包括用户策略，IP地址和端口，以及安全策略，借助脚本  
● 升级：“推”“拉（在线升级）”  

● 遵循稳定优先的原则，服务器一旦运行在稳定的状态，应避免不必要的升级，以免引起诸如软件和系统不兼容等问题。  


# 数据中心的构建与管理 | 数据中心的管理和维护（3. 数据的管理和维护）
● 数据是信息系统最重要的资产  
● 系统为中心->数据为中心  
● 基于数据开发软件满足需求，找贫困生  
● 数据安全：存储靠备份、传输靠加密  


## 3.1 数据管理的核心工作
数据管理和维护主要包括数据备份与恢复、数据整合、数据存档和数据挖掘等  
● 数据备份是指创建数据的副本，在系统失效或数据丢失时通过副本恢复原有数据  
● 数据整合通过将一种格式的数据转换成另一种格式，达到在多个系统之间共享数据和消除冗余的目的（“一张表工程”）  
● 数据归档是指将长期不用的数据提取出来保存到其他数据库的过程  
● 数据挖掘是从归档数据库中分析寻找有价值的信息的过程  


# 数据中心的构建与管理 | 数据中心的管理和维护（4. 资源管理）
● 负载均衡是资源管理的重要内容，数据中心管理和维护时应做到负载均衡，以避免资源浪费或形成系统瓶颈。  
● 系统负载不均衡主要体现在以下几个方面：  
  1. 同一服务器内不同类型的资源使用不均衡：例如内存已经严重不足，但CPU利用率仅为10%（解决方案：内存扩容，虚拟化）  
  2. 同一应用不同服务器间的负载不均衡：Web应用的三层架构，需根据业务请求的压力分配情况决定三层的配比（解决方案：虚拟化进行动态调整）  
  3. 不同应用之间的资源分配不均衡：数据中心往往运行着多个应用，每个应用对资源的需求是不同的，应按照应用的具体要求来分配系统资源（解决方案：动态调整需要虚拟化）  
  4. 时间不均衡：用户对业务的使用存在高峰期和低谷期，这种不均衡具有一定的规律，例如晚上的负载大于白天，白天的负载大于深夜（示例：白天业务系统，晚上数据同步、备份更新）  


# 数据中心的构建与管理 | 数据中心的管理和维护（5. 安全管理）
● 数据中心的安全管理包括物理安全管理和系统安全管理  
● 为保证物理安全，数据中心需要配备完善的安保系统，该系统应实现7*24小时实时监控和录像、人员出入控制、人员远距离定位和联网报警功能  
● 系统安全主要是防止恶意用户攻击系统或窃取数据  
● 系统攻击大致分为两类：  
  1. 以扰乱服务器正常工作为目的，如DDOS攻击等；  
  2. 以入侵或破坏服务器为目的，如窃取服务器机密数据、修改服务器网页等（这一类攻击的影响更为严重，需做网页防篡改）。  


## 5.1 常见安全措施
数据中心需要采取安全措施，有效地避免这两类攻击，常见的安全措施有以下几种：  
● 给服务器的账号设定安全的密码  
● 采用安全防御系统，包括防火墙、入侵检测系统等  
● 定时升级，及时给系统打补丁  
● 关闭不必要的系统服务  
● 保留服务器的日志  


# 数据中心的构建与管理 | 提纲目录（重复）
● 数据中心概述
● 数据中心的设计与构建
● 数据中心的管理和维护
● 数据中心的需求和挑战
● 小结


# 数据中心的构建与管理 | 数据中心的需求和挑战（概述）
数据中心为信息服务提供运行平台，数据中心的需求和挑战源于信息服务的要求，主要体现在合理规划、可管理性、可伸缩性、可靠性、成本降低、节能环保等方面  


# 数据中心的构建与管理 | 数据中心的需求和挑战（1. 合理规划）
● 数据中心的建设是一项系统工程，从选址到建设，从计算机设备到制冷系统，从网络安全到灾难防备，无一不需要合理规划  
● 数据中心通常可以运行三十年左右，要使数据中心在这三十年时间内始终保持经济的运行状态，有很多复杂的因素需要考虑，如服务器、制冷系统的更新周期  
● 由于难以预测信息系统的变化，有一些问题不能在设计数据中心时做出准确的规划  


# 数据中心的构建与管理 | 数据中心的需求和挑战（2. 可管理性）
● 可管理性是指一个系统能够满足管理需求的能力及管理该系统的便利程度。  
● 数据中心的可管理性需求包含以下几个方面：  
  - 完备性：计算、存储、网络、安全、UPS、空调  
  - 远程管理：带外  
  - 集成控制台：多台设备统一管理  
  - 快速响应：  
  - 可追踪性：操作日志记录  
  - 方便性：pdsh改密码  
  - 自动化：下载安装部署配置自动化（docker）  


# 数据中心的构建与管理 | 数据中心的需求和挑战（3. 可伸缩性）
● 可伸缩性是指一个系统适应负载变化的能力，在负载变大时提高自身的能力以适应负载  
● 数据中心需要具备高可伸缩性的IT基础架构，可伸缩性可以从“伸”和“缩”两个角度理解  


## 3.1 高可伸缩性的需求来源
高可伸缩性的需求主要源于以下几点：  
● 用户对服务的使用呈现规律性的高峰期和低谷期  
● 突发事件会对信息服务的负载造成难以预测的影响  
● 信息服务的使用量会随着业务的发展而增长，长期来看呈现上升的趋势  
● 新的服务层出不穷，对资源的需求也难以预测  

**目前解决办法**：规模化，通过资源的统一管理实现（虚拟化）  


# 数据中心的构建与管理 | 数据中心的需求和挑战（4. 可靠性）
● 可靠性对数据中心的重要性不言而喻，在设计数据中心时应尽早考虑  
● 提高可靠性的主要方法有故障避免和故障容错  
● 故障避免是指提高单个组件的可靠性，减少其失效的概率  
● 故障容错是指增加冗余组件，例如增加备份电源等手段  
● 虚拟化可以提高可靠性（虚机的HA开关）  


# 数据中心的构建与管理 | 数据中心的需求和挑战（5. 降低成本）
● 数据中心的成本构成分为一次性成本和运营成本  
● 一次性成本主要包括建筑成本、服务器采购成本和其他设备采购成本  
● 运营成本主要包括电力消耗和管理维护成本  
● 早期一次性成本占比非常高，现在运营成本占比越来越高  


# 数据中心的构建与管理 | 数据中心的需求和挑战（6. 节能环保）
● 电能利用率（Power Usage Effectiveness, PUE）是总能耗与IT设备能耗的比值  
● PUE值越接近1说明其他设备的能耗越小，效率越高  
● PUE值取决于数据中心基础设施的设计和建设水平及所处环境的气候条件  
● 能效利用率比较高的机房PUE值在1.6-1.8，一般的数据中心PUE值在2.0-2.5之间，中小型数据中心PUE值更高，有的甚至在3.0以上。  


# 数据中心的构建与管理 | 提纲目录（重复）
● 数据中心概述
● 数据中心的设计与构建
● 数据中心的管理和维护
● 数据中心的需求和挑战
● 小结

# 虚拟化与云计算技术——虚拟化概论
课程代码：CSE33205C  
授课教师：尤国华  
E-mail：yough@mail.buct.edu.cn  


## 一、提纲目录
### 内容提示
本讲主要讲解虚拟化技术发展、定义以及分类，重点介绍当前最重要的服务器虚拟化技术，对它的概念、支撑技术、优势特点及性能进行分析和阐述，并讨论在数据中心被广泛采纳的其他虚拟化技术。

### 核心章节
- 虚拟化的定义
- 服务器虚拟化技术
- 其他虚拟化技术
- 小结


## 二、虚拟化的定义
### 1. 虚拟化的发展
- 虚拟化技术是伴随着计算机技术的产生而出现的（上世纪50年代）  
  1959年6月，牛津大学的计算机教授克里斯托弗·斯特雷奇（Christopher Strachey）在国际信息处理大会（International Conference on Information Processing）上发表了一篇名为《大型高速计算机中的时间共享》（Time Sharing in Large Fast Computer）的学术报告，他在文中首次提出了“虚拟化”的基本概念，还论述了什么是虚拟化技术。这篇文章被认为是最早的虚拟化技术论述，从此拉开了虚拟化发展的帷幕。

- 大型机上实现了虚拟化的商用（上世纪60年代）  
  1962年，第一台超级计算机Atlas 1诞生，Atlas 1是第一台实现了虚拟内存（Virtual Memory）概念的计算机，并将其称为一级存储（one-level store）。

- 虚拟内存到Java语言虚拟机  
  - 机器语言、汇编语言：与机器有关  
  - 高级语言：操作系统屏蔽机器差异，高级语言与机器无关，但高级语言依然与操作系统有关  
  - 半编译语言，脚本语言：JVM、运行时屏蔽操作系统差异，半编译语言和脚本语言与操作系统无关  
  （对应逻辑：java->编译->半编译程序 → JVM；高级语言->编译->可执行程序 → 操作系统；机器语言、汇编语言 → 计算机）

- 到目前基于x86、ARM架构的服务器虚拟化技术  
  - 代表产品：VMware, KVM/QEMU, HyperV, XEN；Parallel Desktop，VMware Fusion  
  - 再到数据中心虚拟化：计算资源虚拟化、存储资源虚拟化、网络资源虚拟化


### 2. 为什么计算机系统可以虚拟化
（1）计算机系统是分层的，且上层的运行不依赖于下层的具体实现  
（2）计算机系统层级之间是通过接口调用的  

计算机系统各层之间形成黑盒，有“移花接木”的可能  
（系统分层：应用程序 → 中间件 → 操作系统 → 计算机硬件系统）


### 3. 虚拟化技术实现与性能影响
- 实现逻辑：在计算机系统不同层次之间构建虚拟化层，向上提供与真实层次相同或类似的功能，使得上层系统可以运行在虚拟化层上  
- 副作用：由于引入了中间层，虚拟化不可避免地会带来一定的性能影响  

（架构对比：  
传统物理架构：应用程序 → 操作系统 → 硬件资源  
虚拟化架构：虚拟机VM（含应用程序、Guest OS）→ Hypervisor/宿主操作系统（Host OS）→ 硬件资源）


### 4. 虚拟化的定义
- 定义：虚拟化是资源的逻辑表示  
- 定义说明：  
  （1）虚拟化的对象可以是各种各样的资源  
  （2）不受物理限制的约束  
  （3）经过虚拟化后的逻辑资源对用户隐藏了不必要的细节  
  （4）可以在虚拟环境中实现其在真实环境中的部分或全部功能


### 5. 虚拟化的常见类型
（1）基础设施虚拟化  
（2）系统虚拟化  
（3）软件虚拟化  


#### （1）基础设施虚拟化
主要包括网络虚拟化和存储虚拟化  

- 网络虚拟化：  
  定义：将网络的硬件和软件资源整合，向用户提供虚拟网络连接的虚拟化技术  
  优点：灵活  
  常见技术：veth pair, br, OVS, DVS；VPN, VLAN, VxLAN；NFV, SDN  
  目标：实现“网上建网”  
  核心概念：  
  - Underlay: 物理网络基础设施  
  - Overlay: 构建在Underlay之上的逻辑网络层  

- 存储虚拟化：  
  定义：为物理的存储设备提供一个抽象的逻辑视图，用户可以通过这个视图中的统一逻辑接口来访问被融合的存储资源  
  目的：  
  （1）更大容量：NAS、SAN、RAID0  
  （2）更加安全：RAID1、RAID5、RAID10  
  （3）更为灵活：LVM  
  （4）更快速度：RAID0  
  主要形式：  
  - 基于存储设备的存储虚拟化：典型代表为磁盘阵列技术（Redundant Array of Inexpensive Disks, RAID）  
  - 基于网络的存储虚拟化：典型代表为网络附加存储（Network Attached Storage, NAS）和存储区域网（Storage Area Network, SAN）  


#### （2）系统虚拟化
- 定义：使用虚拟化软件在一台物理机上虚拟出一台或多台虚拟机（Virtual Machine, VM）  
- 虚拟机定义：使用系统虚拟化技术，运行在一个隔离环境中、具有完整硬件功能的逻辑计算机系统，包括客户操作系统和其中的应用程序  

- 特点：  
  （1）多个虚拟机可在同一物理机上同时运行，互不影响，复用物理机资源  
  （2）虚拟运行环境需为虚拟机提供虚拟硬件环境（虚拟处理器、内存、设备与I/O、网络接口等）  
  （3）虚拟运行环境提供硬件共享、统一管理、系统隔离等特性  

- 表现形式：  
  （1）服务器虚拟化：价值核心，优势为利用率高、节省空间、便于管理、降低能耗  
  （2）桌面虚拟化：解除用户桌面环境与物理机的耦合，访问灵活，程序和数据在服务器端  


#### （3）软件虚拟化
主要包括应用虚拟化和高级语言虚拟化  

- 应用虚拟化：将应用程序与操作系统解耦合，为应用程序提供虚拟运行环境；典型案例：浏览器与Javascript，VC与lua混编的程序，微信小程序等  
- 高级语言虚拟化：解决可执行程序在不同体系结构计算机间的迁移问题；典型案例：JVM  


## 三、服务器虚拟化技术
### 1. 基本概念
- 定义：通过系统虚拟化技术，将一个服务器虚拟成若干个服务器使用  
- 功能：为虚拟服务器提供支持运行的硬件资源抽象（虚拟BIOS、虚拟处理器、虚拟内存、虚拟设备与I/O），并提供良好的隔离性和安全性  
- 作用：单一物理服务器可运行多个虚拟服务器，资源利用率高，节省空间，省电节能，便于管理  

- 主流服务器虚拟化产品：  
  - VMware公司：VMware Workstation、VMware vSphere  
  - 国内厂商（华三、华为、阿里、深信服）：基于KVM/QEMU的虚拟化产品  
  - Citrix公司：Xen  
  - IBM公司：PowerVM、zVM  
  - Microsoft公司：Virtual PC、Virtual Server、Hyper-V  


### 2. 典型实现
服务器虚拟化通过虚拟化软件向上提供硬件设备抽象和虚拟服务器管理，核心组件包括：  
（1）虚拟机监视器（VMM）：负责为虚拟机提供硬件资源抽象，为客户操作系统提供运行环境  
（2）虚拟化平台：负责虚拟机的托管和管理，直接运行在硬件之上  

（注：VMM与虚拟化平台不严格区分，可混用）  

- 虚拟化软件功能：  
  （1）硬件抽象：CPU、内存、设备和I/O的超分  
  （2）资源分配：以虚拟机为单位  
  （3）调度和管理：虚机管理、负载均衡  
  （4）隔离：虚拟机与宿主机及多个虚拟机间的隔离  


#### 按虚拟化层实现方式分类
##### （1）寄宿虚拟化（宿主虚拟化）
- 特点：  
  ① 虚拟机监视器运行在宿主操作系统上，实现硬件资源抽象和虚拟机管理  
  ② 实现容易，性能通常较低  
- 典型产品：VMware Workstation、Microsoft Virtual PC  
- 架构：虚拟机 → 虚拟机监视器（VMM）→ 宿主操作系统 → 服务器硬件  


##### （2）原生虚拟化（裸金属虚拟化）
- 特点：  
  ① 虚拟化平台直接运行在硬件之上  
  ② 虚拟机运行在虚拟化平台上，平台提供指令集和设备接口支持  
  ③ 性能良好，实现复杂  
- 典型产品：Citrix Xen、VMware vSphere、Microsoft Hyper-V  


### 3. 关键特性
#### （1）多实例
- 一个物理服务器上可运行多个虚拟服务器  
- 逻辑：服务器虚拟化将服务器逻辑整合到虚拟机中，物理资源（处理器、内存、硬盘、网络等）以可控方式分配给虚拟机  


#### （2）隔离性
- 虚拟机之间完全隔离：  
  ① 部分虚拟机崩溃不影响其他虚拟机  
  ② 虚拟机间不泄露数据  
  ③ 虚拟机间仅通过配置的网络通信  


#### （3）封装性
- 完整虚拟机环境对外表现为单一实体：  
  ① 便于在不同硬件间备份、移动、复制  
  ② 物理机硬件封装为标准化虚拟硬件，兼容性好  
  ③ 硬件无关性，与硬件具体实现无关  


#### （4）高性能
- 核心要求：虚拟化开销控制在可承受范围  
- 逻辑：虚拟机与硬件间增加虚拟化抽象层（VMM/虚拟化平台），抽象层会产生一定开销  


### 4. 核心技术
#### （1）CPU虚拟化
- 定义：把物理CPU抽象成虚拟CPU，每个客户操作系统可使用一个或多个虚拟CPU，且虚拟CPU运行相互隔离  

##### 核心问题：x86处理器特权级别冲突
- 虚拟化前：  
  ① 操作系统（内核）运行在最高特权级Ring0，可执行特权指令（控制中断、修改页表、访问设备等）  
  ② 应用程序运行在最低特权级Ring3  
  （层级：Ring0（操作系统）→ Ring1 → Ring2 → Ring3（应用程序）→ 服务器硬件）  

- 虚拟化后：  
  ① 虚拟机监视器（VMM）占用Ring0  
  ② 客户操作系统运行在Ring1  
  ③ 应用程序运行在Ring3  
  → 问题：客户操作系统无法执行特权指令  


##### 三种CPU虚拟化解决方案
###### A. 全虚拟化：动态二进制翻译
- 技术逻辑：通过动态二进制翻译技术（dynamic Binary Translation，BT）解决特权指令问题  
  ① 将客户操作系统内核态的特权指令，转换为可通过VMM执行的等效指令序列  
  ② 非特权指令直接在物理处理器上运行  
  ③ 实现细节：在特权指令前插入陷入指令 → 执行特权指令时触发异常 → VMM捕获异常 → 动态转换指令序列并执行  

- 特点：  
  ① 客户操作系统“以为”运行在真实物理环境  
  ② 无需修改客户操作系统  
  ③ 动态转换存在性能开销  

- 典型产品：QEMU、VMware、Virtual Server  
- 架构：Ring3（应用程序）→ Ring1（虚拟机操作系统）→ Ring0（虚拟机监视器，含二进制转换）→ 服务器硬件  


###### B. 半虚拟化：超级调用
- 技术逻辑：通过修改客户操作系统解决特权指令问题  
  ① 客户操作系统需修改：将所有特权指令替换为对虚拟化平台的“超级调用”  
  ② 虚拟化平台为超级调用提供接口  

- 特点：  
  ① 客户操作系统“知道”处于虚拟化环境，主动配合VMM  
  ② 需修改客户操作系统  
  ③ 性能优于全虚拟化  
  ④ 对不同版本操作系统支持有限  

- 典型产品：Xen  
- 架构：Ring3（应用程序）→ Ring1（虚拟机操作系统）→ Ring0（虚拟机监视器，含超级调用接口）→ 服务器硬件  


###### C. 硬件辅助虚拟化
- 技术背景：纯软件虚拟化（全/半虚拟化）存在限制（特权指令处理复杂、性能开销、OS支持有限），硬件辅助虚拟化通过CPU硬件升级解决问题  

- 技术逻辑：支持虚拟化的CPU新增指令集和运行模式，客户操作系统可直接运行，无需二进制翻译或超级调用  

- 核心模式（以Intel VT为例）：  
  ① 定义两种模式：root模式（VMM运行）、非root模式（虚拟机操作系统运行）  
  ② 客户操作系统在非root模式下仍可运行于Ring0，直接执行特权指令  

- 特点：性能开销低  

- 架构：Ring3（应用程序）→ 非root模式（Ring1/0，虚拟机操作系统）→ root模式（Ring0，虚拟机监视器）→ 服务器硬件  


#### （2）内存虚拟化
- 定义：将物理机真实物理内存统一管理，包装成多个虚拟物理内存，供若干虚拟机使用，确保每个虚拟机有独立内存空间  

##### 核心问题：地址转换层级增加
- 虚拟化前：  
  ① 进程使用逻辑地址读写数据，数据存储在物理内存（物理地址访问）  
  ② 通过内存映射表实现“逻辑地址→物理地址”转换  

- 虚拟化后：  
  ① 进程仍用逻辑地址，数据存储在“机器内存”（物理机真实内存，机器地址访问）  
  ② 虚拟机内存在“虚拟物理内存”（机器内存的映射）  
  ③ 原内存映射表仅支持“逻辑地址→虚拟物理地址”转换，无法直接访问机器地址  


##### 三种内存虚拟化解决方案
###### A. 全虚拟化：影子页表法
- 技术逻辑：  
  ① 客户操作系统维护“逻辑地址→虚拟物理地址”页表  
  ② VMM为每台虚拟机维护“虚拟物理地址→机器地址”页表（影子页表）  
  ③ 两张页表保持同步（“身”与“影”）  

- 地址转换流程：应用程序逻辑地址 → 客户OS映射为虚拟物理地址 → 陷入VMM → VMM通过影子页表转换为机器地址 → 访问内存  

- 特点：  
  ① 客户操作系统“以为”运行在真实环境  
  ② 无需修改客户操作系统  
  ③ 维护影子页表存在性能开销  

- 典型产品：KVM、VMware、Virtual Server  


###### B. 半虚拟化：页表写入法
- 技术逻辑：  
  ① 修改客户操作系统，让VMM拥有维护内存映射表的权限  
  ② 客户OS写入“虚拟物理地址”时，陷入VMM → VMM将其修改为机器地址  
  ③ 地址转换：应用程序逻辑地址 → 内存映射表（直接映射为机器地址）→ 访问内存  

- 特点：  
  ① 仅一张内存映射表（由VMM维护）  
  ② 需修改客户操作系统  
  ③ 性能高于影子页表法  

- 典型产品：Xen  


###### C. 硬件辅助虚拟化：扩展页表
- 技术逻辑：在影子页表法基础上，Intel CPU支持扩展页表（Extended Page Table, EPT），用EPT替代影子页表，提升转换效率  

- 核心：EPT直接实现“虚拟物理地址→机器地址”转换，减少VMM干预  


#### （3）设备与I/O虚拟化
- 定义：将物理机真实设备统一管理，包装成多个虚拟设备供虚拟机使用，响应设备访问和I/O请求  

##### 三种设备与I/O虚拟化解决方案
###### A. 全虚拟化
- 流程：应用程序→设备驱动（请求）→ VMM拦截请求→虚拟设备→设备驱动→硬件设备  

- 特点：无需修改客户操作系统，存在性能开销  


###### B. 半虚拟化
- 技术逻辑：修改虚拟机操作系统，替换设备驱动为“前端驱动”  
- 流程：应用程序→前端驱动→后端驱动（VMM层）→虚拟设备→设备驱动→硬件设备  

- 架构：虚拟机A/B（应用程序→前端驱动）→ 后端驱动→虚拟设备→设备驱动→虚拟机监视器→硬件设备  


###### C. 硬件辅助虚拟化
- 场景1：多同功能硬件设备 → 直接“挂载”硬件设备到虚拟机，由虚拟机独占  
- 场景2：支持SR-IOV（Single Root I/O Virtualization）的设备 → 虚拟出多个同功能虚拟设备，分别透传至虚拟机  

- 架构1（独占设备）：虚拟机A/B（应用程序→设备驱动）→ 透传→设备驱动→虚拟机监视器→硬件设备1/2  
- 架构2（SR-IOV）：虚拟机A/B（应用程序→设备驱动）→ 透传→虚拟硬件设备1/2→虚拟机监视器→物理设备  


#### （4）实时迁移技术
- 定义：虚拟机运行过程中，将其完整运行状态从原宿主机硬件平台迁移到目标宿主机，过程平滑，用户无感知  
- 核心优势：支持原宿主机与目标宿主机硬件异构（虚拟化抽象物理资源）  
- 迁移目的：负载均衡、设备维护  

- 架构：Guests（虚拟机）→ Hypervisor（原宿主机）→ Hypervisor（目标宿主机）→ Servers（物理服务器），共享Storage（存储）  


## 四、其他虚拟化技术
### 1. 网络虚拟化
#### （1）核心技术分类
- VLAN（虚拟局域网）：局域网虚拟化典型技术，实现同一物理网络内的逻辑隔离  
- VPN（虚拟专用网）：广域网虚拟化主流技术，通过公共网络建立加密专用连接  
- VxLAN（Virtual eXtensible Local Area Network）：overlay技术核心，满足虚拟化、云计算场景下的网络扩展需求  
  - 核心组件：VTEP（VXLAN隧道端点）、VNI（VXLAN网络标识）  
  - 流程：源端VTEP封装数据→VXLAN隧道传输→目的端VTEP解封装  
- veth pair：成对虚拟设备接口，实现虚拟网络/设备（虚拟机、容器、虚拟交换机）间互联，类似物理网线（数据从一端进、另一端出）  
  - 架构：ns0（命名空间）→ veth0 ↔ veth1 → ns1（命名空间）  
- Linux Bridge（网桥）：二层虚拟网络设备，功能类似物理交换机；可绑定其他Linux网络设备作为“端口”，实现设备间二层通信  
  - 架构：VM0/1（tap0/1）→ br0（网桥）→ eth0 → Hardware Switch（物理交换机）  
- OVS（Open vSwitch）：开源虚拟以太网交换机，支持多种管理接口和协议（含OpenFlow），可整合开源虚拟化平台  
  - 架构：Controller（控制器）→ OpenFlow → Open vSwitch → VM（Alice/Peter）/ Hardware Switch  
- DVS（分布式虚拟交换机）：功能类似物理交换机，每台主机连接到分布式交换机；一端为虚拟机虚拟端口，另一端为物理以太网适配器上行链路，实现系统网络互通  
  - 架构：Host1/2（VM1-4）→ DVS1/2 → Hardware Switch  
- NFV（网络功能虚拟化）：通过虚拟化技术在标准化IT设备（X86服务器、存储、交换设备）上实现网络功能，常用虚拟机模拟网络设备（虚拟DNS、虚拟防火墙、虚拟交换机等）  
  - 架构：NFV管理与编排 → 虚拟网络功能（VNF）→ NFV基础设施（NFVI：虚拟计算/存储/网络→虚拟化层→计算/存储/网络硬件）  
- SDN（软件定义网络）：通过软件编程定义和控制网络，核心是“控制面与数据面分离”，实现流量灵活控制  
  - 架构：SDN网络应用→北向接口→SDN控制器→南向接口→SDN数据平面（通用硬件）  


### 2. 存储虚拟化
#### （1）核心技术分类
- RAID（磁盘阵列）：基于存储设备的虚拟化技术，通过多磁盘组合提升容量、性能或安全性  
  | RAID级别 | 优点 | 缺点 |
  |---|---|---|
  | RAID 0 | 最高性能 | 无冗余 |
  | RAID 1 | 数据安全（镜像） | 容量利用率低（50%） |
  | RAID 5 | 高效容错（分布式校验） | 写入性能受限 |
  | RAID 10 | 性能与安全兼顾 | 成本高、容量折半 |

- NAS（网络附加存储）：基于网络的虚拟化技术，通过IP网络提供文件级存储服务，架构：应用程序→操作系统→IP网络→NAS设备（一组磁盘组成的RAID盘柜）  
- SAN（存储区域网）：基于网络的虚拟化技术，通过FC/FCoE/iSCSI协议提供块级存储服务，架构：应用程序→操作系统→SAN交换机（FC/FCoE/iSCSI）→ SAN设备（一组磁盘组成的RAID盘柜）  
- LVM（逻辑卷管理）：在硬盘分区基础上构建逻辑层，灵活管理存储设备  
  - 核心组件：  
    ① PV（Physical Volume，物理卷）：硬盘或RAID磁盘阵列  
    ② VG（Volume Group，卷组）：多个PV组成的存储池  
    ③ LV（Logical Volume，逻辑卷）：基于VG分配的逻辑存储单元  
    ④ PE（Physical Extent，物理扩展块）：LV分配的最小单位（需为PE整数倍）  
  - 优点：无损增删分区、调整分区大小、存储空间抽象化  
  - 架构：PV1/PV2 → VG（卷组，含PE）→ LV（逻辑卷A/B）  

- VMware FS（VMware文件系统）：VMware专用存储管理技术，采用VMFS或NFS协议管理虚拟机磁盘  
  - 核心：虚拟机由文件构成，核心为虚拟磁盘文件（VMDK文件）；虚拟机I/O操作本质是对VMDK文件的读写  


### 3. 桌面虚拟化
- 定义：将用户桌面环境与终端设备解耦合，服务器存储每个用户的完整桌面环境  
- 访问逻辑：用户通过终端设备（PC、智能手机等，需足够处理/显示能力），通过网络访问服务器上的桌面环境  


### 4. 应用虚拟化
- 定义：为应用程序提供虚拟运行环境，包含应用可执行文件及所需运行时环境  
- 运行逻辑：  
  ① 应用程序不完整安装在本地硬盘，从中央服务器下载至本地虚拟环境运行  
  ② 关闭应用后，下载文件可完全删除，无本地残留  


## 五、小结
本讲围绕虚拟化技术展开，核心内容包括：  
1. 虚拟化定义：从发展历程（1950s概念提出→1960s大型机商用→x86/ARM服务器虚拟化→数据中心虚拟化）、系统可虚拟化原因（分层+接口调用）、定义（资源的逻辑表示）及分类（基础设施/系统/软件虚拟化）展开；  
2. 服务器虚拟化技术：作为核心重点，涵盖基本概念（定义、功能、产品）、典型实现（寄宿/原生虚拟化）、关键特性（多实例、隔离性、封装性、高性能）及核心技术（CPU/内存/设备与I/O虚拟化、实时迁移）；  
3. 其他虚拟化技术：包括网络虚拟化（VLAN/VPN/VxLAN等）、存储虚拟化（RAID/NAS/SAN/LVM等）、桌面虚拟化、应用虚拟化，覆盖数据中心常见虚拟化场景，为云计算奠定基础。
